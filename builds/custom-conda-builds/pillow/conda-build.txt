
## Info

This conda recipe is based on:
https://github.com/conda-forge/pillow-feedstock

I had to remove from the recipe:
- libtiff: which needs jpeg - so to move forward need to either move it from the conda recipe - or find a libtiff built against libjpeg-turbo
- tk: it wants some high tk[version='>=8.6.9,<8.7.0a0'], so removed that from the recipe as well.

## Successful Builds

* python 3.6 + pillow-dev (5.4.0.dev git HEAD) + `-c conda-forge libjpeg-turbo` (bad idea though because it taps into a whole pile of packages from `conda-forge`
* python 3.7 + pillow-dev (5.4.0.dev git HEAD) + custom-built `libjpeg-turbo` conda package (via builds/custom-conda-builds/libjpeg-turbo)
*

## Failing Builds

* python 3.6 + `-c conda-forge libjpeg-turbo` + pillow 5.3.0 somehow forces tk in, which relies on `jpeg` - a no go w/o additional investigation!
* python 3.7 failing + `-c conda-forge libjpeg-turbo` + any pillow
ModuleNotFoundError: No module named '_sysconfigdata_x86_64_conda_cos6_linux_gnu'
Unresolved issue of mixing conda-forge and main channels - toolchain conflicts:
https://github.com/conda-forge/python-feedstock/issues/220

## Prep

conda install -y conda-build conda-verify
cd builds/custom-conda-builds/pillow # this dir
git clone https://github.com/python-pillow/Pillow Pillow
cd Pillow
# optionally switch to a desired release tag, otherwise you're on the bleeding edge
# git checkout tags/5.3.0
cp -r ../recipe .


## Build

Can build against the conda-forge libjpeg-turbo, or against a locally built one (the latter is much better)

### Build against a custom build libjpeg-turbo conda package

conda uninstall -y --force pillow pil jpeg libtiff
pip   uninstall -y         pillow pil jpeg libtiff

# presumes it was built locally - see builds/custom-conda-builds/libjpeg-turbo
conda install -c ${CONDA_PREFIX}/conda-bld/ libjpeg-turbo

python setup.py sdist
MAKEFLAGS="-j" conda-build -c conda-forge recipe/meta.yaml


### Build against -c conda-forge libjpeg-turbo

conda uninstall -y --force pillow pil jpeg libtiff
pip   uninstall -y         pillow pil jpeg libtiff

conda install -y -c conda-forge libjpeg-turbo

python setup.py sdist
MAKEFLAGS="-j" conda-build -c conda-forge recipe/meta.yaml



## Install

conda install -c ${CONDA_PREFIX}/conda-bld/ pillow

# need to add the build channel as highest priority, otherwise the
# package will get overridden with `conda install pillow` or any other
# install/update that depends on pillow.
conda config --prepend channels ${CONDA_PREFIX}/conda-bld/
# this is for local use - if this package ends up on the `fastai`
# conda channel, then this should be done instead:
# conda config --prepend channels fastai




## Check

python -m fastai.utils.check_perf


# list out the active channels and their priorities
conda config --get channels


## Upload to fastai's anaconda channel

Probably start with label/test:

anaconda upload anaconda3/envs/xxx/conda-bld/linux-64/libjpeg-turbo-xxx.tar.bz2 -u fastai --label test
anaconda upload anaconda3/envs/xxx/conda-bld/linux-64/pillow-xxx.tar.bz2 -u fastai --label test

and to install from the test label:

conda uninstall -y pillow libjpeg-turbo
conda install -c fastai/label/test pillow
